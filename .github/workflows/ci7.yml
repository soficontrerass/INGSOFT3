name: CI7 - tests, coverage, SonarCloud, Cypress

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: 18
      COVERAGE_THRESHOLD: 70
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install server dependencies
        run: |
          cd server
          npm ci

      - name: Run server tests (Jest + coverage)
        run: |
          cd server
          npm run test:ci

      - name: Upload server coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-coverage
          path: server/coverage

      - name: Install client dependencies
        run: |
          cd client
          npm ci

      - name: Run client tests (Vitest + coverage)
        run: |
          cd client
          npm run test:ci

      - name: Upload client coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-coverage
          path: client/coverage

      - name: Check coverage thresholds (server & client)
        shell: bash
        run: |
          node -e "
          const fs = require('fs');
          const read = p => fs.existsSync(p) ? JSON.parse(fs.readFileSync(p)) : null;
          const sv = read('server/coverage/coverage-summary.json');
          const cv_paths = [
            'client/coverage/coverage-summary.json',
            'client/coverage/coverage-final.json',
            'client/coverage/coverage-summary.json'
          ];
          let cv = null;
          for (const p of cv_paths) { if (!cv) cv = read(p); }
          if (!sv) { console.error('Missing server coverage-summary.json at server/coverage/coverage-summary.json'); process.exit(1); }
          if (!cv) { console.error('Missing client coverage summary (tried multiple paths). Ensure Vitest is configured to emit coverage-summary.json'); process.exit(1); }
          const sPct = sv.total.lines.pct;
          const cPct = cv.total.lines.pct;
          console.log('Server lines pct:', sPct, '%');
          console.log('Client lines pct:', cPct, '%');
          const min = parseFloat(process.env.COVERAGE_THRESHOLD || '70');
          if (sPct < min || cPct < min) { console.error(`Coverage threshold not met (min ${min}%).`); process.exit(1); }
          console.log('Coverage threshold met.');
          "

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          projectBaseDir: .
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}

      - name: Start backend for E2E
        run: |
          cd server
          # start server in background for Cypress; adjust if your start script differs
          npm run start &>/dev/null & echo $! > server.pid
        continue-on-error: false

      - name: Run Cypress E2E tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: client
          start: npm --prefix ../server run start
          wait-on: 'http://localhost:8080'
          wait-on-timeout: 60
          browser: chrome
          record: false

      - name: Stop backend
        if: always()
        run: |
          if [ -f server/server.pid ]; then kill $(cat server/server.pid) || true; rm -f server/server.pid; fi

      - name: Upload Cypress results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results
          path: client/cypress/results || client/cypress/videos || client/cypress/screenshots

      - name: Final status
        run: echo "CI7 pipeline completed"