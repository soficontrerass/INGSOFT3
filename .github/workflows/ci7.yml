name: CI7 - tests, coverage, SonarCloud, Cypress

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      NODE_VERSION: '20'
      COVERAGE_THRESHOLD: 70
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Show node & npm versions (debug)
        run: |
          node -v
          npm -v
          pnpm -v || true

      - name: Install server dependencies
        run: |
          cd TP7/server
          npm ci

      - name: Run server tests (Jest + coverage)
        run: |
          cd TP7/server
          npm run test:ci

      - name: Upload server coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: server-coverage
          path: TP7/server/coverage

      - name: Install client dependencies
        run: |
          cd TP7/client
          npm ci

      - name: Run client tests (Vitest + coverage) - debug
        run: |
          echo "=== pwd ==="
          pwd
          echo "=== node / npm versions ==="
          node -v
          npm -v
          echo "=== show client package.json ==="
          sed -n '1,200p' TP7/client/package.json || true
          echo "=== ls client dir ==="
          ls -la TP7/client || true
          echo "=== ensure deps installed (debug) ==="
          cd TP7/client
          npm ci
          echo "=== run tests verbose ==="
          # run tests with verbose output and print logs on failure
          npm run test:ci -- --runInBand --reporter verbose || (echo "Tests failed, printing npm debug log if exists" && ls -la ./npm-debug.log || true && exit 1)

      - name: Upload client coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: client-coverage
          path: TP7/client/coverage

      - name: Check coverage thresholds (server & client)
        run: node TP7/tools/check-coverage.js

      - name: Normalize LCOV paths for Sonar (fix backslashes and add repo prefixes)
        run: |
          cd TP7
          if [ -f client/coverage/lcov.info ]; then
            sed -i 's#\\#/#g' client/coverage/lcov.info || true
            sed -i -E 's#^SF:(\./)?src/#SF:client/src/#' client/coverage/lcov.info || true
            sed -i -E 's#^SF:.*client/src/#SF:client/src/#' client/coverage/lcov.info || true
          fi
          
      - name: Debug:show server coverage file
        run: |
          echo "PWD: $(pwd)"
          ls -la TP7/server/coverage || true
          echo "---- head of lcov ----"
          if [ -f TP7/server/coverage/lcov.info ]; then head -n 40 TP7/server/coverage/lcov.info; else echo "no lcov for server"; fi

      - name: SonarCloud Scan
        uses: sonarsource/sonarcloud-github-action@v2
        with:
          projectBaseDir: TP7
          args: >-
            -Dsonar.login=${{ secrets.SONAR_TOKEN }}
            -Dsonar.sources=server/src,client/src
            -Dsonar.javascript.lcov.reportPaths=server/coverage/lcov.info,client/coverage/lcov.info
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: Check SonarCloud Quality Gate
        if: always()
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # reemplazar por tu sonar.projectKey si es distinto
          SONAR_PROJECT_KEY="soficontrerass"
          echo "Checking SonarCloud Quality Gate for $SONAR_PROJECT_KEY"
          sudo apt-get update -y
          sudo apt-get install -y jq curl
          MAX_ATTEMPTS=12
          SLEEP_SEC=5
          attempt=0
          status=""
          resp=""
          while [ $attempt -lt $MAX_ATTEMPTS ]; do
            attempt=$((attempt+1))
            echo "Attempt $attempt/$MAX_ATTEMPTS..."
            resp=$(curl -s -u "$SONAR_TOKEN:" "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}")
            status=$(echo "$resp" | jq -r '.projectStatus.status' 2>/dev/null || echo "")
            if [ "$status" = "OK" ] || [ "$status" = "ERROR" ]; then
              break
            fi
            sleep $SLEEP_SEC
          done
          echo "SonarCloud quality gate status: '$status'"
          if [ "$status" != "OK" ]; then
            echo "Quality Gate NOT OK. Response:"
            echo "$resp"
            exit 1
          fi

      - name: Start backend for E2E
        run: |
          cd TP7/server
          npm run start &>/dev/null & echo $! > server.pid
        continue-on-error: false

      - name: Install client dependencies for Cypress
        run: npm ci --prefix TP7/client

      - name: Run Cypress E2E tests
        uses: cypress-io/github-action@v6
        with:
          working-directory: TP7/client
          wait-on: 'http://localhost:8080'
          wait-on-timeout: 60
          browser: chrome
          record: false

      - name: Stop backend
        if: always()
        run: |
          if [ -f TP7/server/server.pid ]; then kill $(cat TP7/server/server.pid) || true; rm -f TP7/server/server.pid; fi

      - name: Upload Cypress results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results
          path: |
            TP7/client/cypress/results
            TP7/client/cypress/videos
            TP7/client/cypress/screenshots

      - name: Final status
        run: echo "CI7 pipeline completed"