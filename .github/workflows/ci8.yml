name: CI8 - GCP Cloud Run

on:
  push:
    branches: [ main ]
    paths:
      - 'TP8/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'TP8/**'
  workflow_dispatch: {}

env:
  REGION: us-central1
  REPOSITORY: ${{ secrets.ARTIFACT_REPO }}
  IMAGE_NAME: tp8-server

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install & Test (server)
        working-directory: TP8/server
        run: |
          npm ci
          npm run test:ci

# Job: construir la imagen Docker, subirla al Artifact Registry y desplegar en QA
  publish-and-deploy-qa:
    needs: build-and-test
    runs-on: ubuntu-latest
    environment: qa8
    steps:
      - uses: actions/checkout@v4

      # Escribir la clave de servicio GCP (QA) en un archivo local con manejo de nuevos saltos de línea
      - name: Write GCP key (QA) (robust)
        env:
          KEY: ${{ secrets.GCP_SA_KEY_QA8 }}
        run: |
          # show length of the secret variable (no muestra su contenido)
          echo -n "secret length (bytes): "
          echo -n "${KEY}" | wc -c
          if [ -z "${KEY}" ]; then
            echo "ERROR: secret is empty or wrong name. Check repo/ environment secrets."
            exit 1
          fi
          # write exactly and try to fix escaped newlines
          printf '%s' "$KEY" > /tmp/gcp-key.json
          if ! python3 -c "import json,sys; json.load(open('/tmp/gcp-key.json'))" 2>/dev/null; then
            sed 's/\\n/\n/g' /tmp/gcp-key.json > /tmp/gcp-key-fixed.json || true
            mv /tmp/gcp-key-fixed.json /tmp/gcp-key.json || true
          fi
          echo "wrote /tmp/gcp-key.json bytes:" $(wc -c < /tmp/gcp-key.json)

      # Configurar gcloud usando la clave escrita (QA)
      - name: Setup gcloud (QA)
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: /tmp/gcp-key.json
          project_id: ${{ secrets.GCP_PROJECT8_ID }}
          export_default_credentials: true

      # Activar la cuenta de servicio y configurar docker para empujar a Artifact Registry
      - name: Activate SA & configure Docker (fallback)
        run: |
          set -euo pipefail
          echo "=== /tmp/gcp-key.json info ==="
          ls -l /tmp/gcp-key.json || { echo "FILE MISSING"; exit 1; }
          echo "first 200 bytes:"
          head -c 200 /tmp/gcp-key.json || true
          echo; echo "=== Try activate service account ==="
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          echo "=== gcloud auth list ==="
          gcloud auth list
          echo "=== gcloud config project ==="
          gcloud config get-value project || true
          echo "=== configure-docker ==="
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet || echo "configure-docker failed"
          echo "=== fallback: docker login with access token ==="
          TOKEN=$(gcloud auth print-access-token)
          echo "token length: ${#TOKEN}"
          echo "$TOKEN" | docker login -u oauth2accesstoken --password-stdin https://${{ env.REGION }}-docker.pkg.dev || { echo "docker login failed"; exit 1; }
          echo "=== docker info (partial) ==="
          docker info | sed -n '1,20p'

       # Inspección rápida del workspace (diagnóstico)
      - name: Inspect repo (diagnóstico)
        run: |
          echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE"
          ls -la "$GITHUB_WORKSPACE"
          ls -la "$GITHUB_WORKSPACE/TP8" || true
          ls -la "$GITHUB_WORKSPACE/TP8/server" || true

      # Construir la imagen Docker del servidor y subirla al Artifact Registry
      - name: Build and push image
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT8_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          echo "Building image: $IMAGE"
          # usar ruta absoluta al contexto para evitar problemas de cwd
          docker build -t "$IMAGE" "$GITHUB_WORKSPACE/TP8/server"
          docker push "$IMAGE"

      # Desplegar la imagen en Cloud Run en el entorno QA con variables de entorno necesarias
      - name: Deploy to Cloud Run (QA)
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT8_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          gcloud run deploy tp8-qa \
            --image $IMAGE \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars NODE_ENV=qa,DATABASE_URL="${{ secrets.DB_URL_QA }}" \
            --service-account ci-deployer@${{ secrets.GCP_PROJECT8_ID }}.iam.gserviceaccount.com

  deploy-prod:
    needs: publish-and-deploy-qa
    runs-on: ubuntu-latest
    environment:
      name: prod8
    steps:
      - uses: actions/checkout@v4

      # Escribir la clave GCP de PROD en archivo local (manejo robusto de nueva línea)
      - name: Write GCP key (PROD) (robust)
        env:
          KEY: ${{ secrets.GCP_SA_KEY_PROD8 }}
        run: |
          printf '%s' "$KEY" > /tmp/gcp-key.json
          if ! python3 -c "import json,sys; json.load(open('/tmp/gcp-key.json'))" 2>/dev/null; then
            sed 's/\\n/\n/g' /tmp/gcp-key.json > /tmp/gcp-key-fixed.json || true
            mv /tmp/gcp-key-fixed.json /tmp/gcp-key.json || true
          fi
          echo "gcp key bytes:" $(wc -c < /tmp/gcp-key.json)

      # Configurar gcloud para PROD usando la clave provisionada
      - name: Setup gcloud (PROD)
        uses: google-github-actions/setup-gcloud@v1
        with:
          service_account_key: /tmp/gcp-key.json
          project_id: ${{ secrets.GCP_PROJECT8_ID }}
          export_default_credentials: true

      # Activar la SA y asegurarse de que el proyecto está configurado (diagnóstico)
      - name: Activate SA & ensure project (diagnostics)
        run: |
          gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
          gcloud config set project "${{ secrets.GCP_PROJECT8_ID }}"
          echo "gcloud account:"
          gcloud auth list
          gcloud config get-value project

      # Desplegar la imagen en Cloud Run en producción con ajustes de memoria y escalado
      - name: Deploy to Cloud Run (PROD)
        run: |
          IMAGE=${{ env.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT8_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          gcloud run deploy tp8-prod \
            --image $IMAGE \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars NODE_ENV=prod,DATABASE_URL="${{ secrets.DB_URL_PROD }}" \
            --memory 1Gi --min-instances=1 --max-instances=5 \
            --service-account ci-deployer@${{ secrets.GCP_PROJECT8_ID }}.iam.gserviceaccount.com