name: Deploy TP5 to Cloud Run

on:
  push:
    branches: [ main ]
    paths:
      - 'TP5/**'
  workflow_dispatch: {}

env:
  REPO: tp5-repo
  PROJECT: ${{ secrets.GCP_PROJECT_ID }}
  REGION: ${{ secrets.GCP_REGION }}
  SHA: ${{ github.sha }}

jobs:
  build:
    name: Build & push images (QA credentials)
    runs-on: ubuntu-latest
    environment: qa
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - verify qa secret available
        env:
          GCP_SA_KEY_QA: ${{ secrets.GCP_SA_KEY_QA }}
        run: |
          if [ -z "$GCP_SA_KEY_QA" ]; then
            echo "ERROR: GCP_SA_KEY_QA is empty or not available in this job"; exit 1
          else
            echo "GCP_SA_KEY_QA is present (len=$(printf '%s' "$GCP_SA_KEY_QA" | wc -c))"
          fi

      - name: Authenticate to GCP (build)
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_QA }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          version: 'latest'

      - name: Build & push server image
        run: |
          SERVER_IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-server:${SHA}"
          echo "Building and pushing ${SERVER_IMAGE}"
          gcloud builds submit TP5/server --tag "${SERVER_IMAGE}" --project "$PROJECT" --region "$REGION"

      - name: Get server URL (temporary, may be empty on first run)
        id: get-server
        run: |
          SERVER_URL=$(gcloud run services describe tp5-server-qa --region "$REGION" --project "$PROJECT" --format='value(status.url)' || echo "")
          echo "SERVER_URL=$SERVER_URL" >> $GITHUB_OUTPUT

      - name: Build & push client image
        run: |
          CLIENT_IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-client:${SHA}"
          echo "Building client image ${CLIENT_IMAGE} with API=${{ steps.get-server.outputs.SERVER_URL }}"
          gcloud auth configure-docker "${REGION}-docker.pkg.dev" --quiet
          # If SERVER_URL is empty, the client will be built with an empty VITE_API_URL;
          # deploy-qa will redeploy client with correct env if needed.
          docker build --build-arg VITE_API_URL="${{ steps.get-server.outputs.SERVER_URL }}" -t "${CLIENT_IMAGE}" TP5/client
          docker push "${CLIENT_IMAGE}"
        env:
          CLOUDSDK_CORE_DISABLE_PROMPTS: "1"

  deploy-qa:
    name: Deploy to QA (automatic)
    needs: build
    runs-on: ubuntu-latest
    environment: qa
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Debug - verify qa secret available
        env:
          GCP_SA_KEY_QA: ${{ secrets.GCP_SA_KEY_QA }}
        run: |
          if [ -z "$GCP_SA_KEY_QA" ]; then
            echo "ERROR: GCP_SA_KEY_QA is empty or not available in this job"; exit 1
          else
            echo "GCP_SA_KEY_QA is present"
          fi

      - name: Authenticate to GCP (QA)
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_QA }}

      - name: Setup gcloud CLI (QA)
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          version: 'latest'

      - name: Record previous server image (QA)
        id: prev_image
        run: |
         PREV=$(gcloud run services describe tp5-server-qa --region "$REGION" --project "$PROJECT" --format='value(spec.template.spec.containers[0].image)' || true)
          echo "PREV_IMAGE=$PREV" >> $GITHUB_ENV
          echo "Prev image: $PREV"

      - name: Deploy server QA (with Cloud SQL)
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-server:${SHA}"
          INSTANCE_CONN_NAME="${{ secrets.INSTANCE_CONN_NAME_QA }}"
          DB_USER="postgres"
          DB_NAME="${{ secrets.DB_NAME_QA }}"
          gcloud run deploy tp5-server-qa \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances "${INSTANCE_CONN_NAME}" \
            --set-env-vars DB_HOST="/cloudsql/${INSTANCE_CONN_NAME}",DB_USER="${DB_USER}",DB_PASS="${{ secrets.DB_PASS_QA }}",DB_NAME="${DB_NAME}" \
            --project "$PROJECT"

      - name: Install node deps & Run DB migrations (QA)
        run: |
          npm ci
          npm run migrate
        env:
          DB_USER: "postgres"
          DB_PASS: ${{ secrets.DB_PASS_QA }}
          DB_NAME: ${{ secrets.DB_NAME_QA }}
          DB_HOST: /cloudsql/${{ secrets.INSTANCE_CONN_NAME_QA }}

      - name: Deploy server QA
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-server:${SHA}"
          gcloud run deploy tp5-server-qa \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars FORECAST_COUNT=5 \
            --project "$PROJECT"

      - name: Deploy client QA (set VITE_API_URL to QA server URL)
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-client:${SHA}"
          SERVER_URL=$(gcloud run services describe tp5-server-qa --region "$REGION" --project "$PROJECT" --format='value(status.url)')
          echo "QA server URL: $SERVER_URL"
          # Re-build client locally in runner only if needed to inject API URL into static bundle.
          # Simpler: deploy container image with env var CLIENT_API set for runtime, if client reads env at runtime.
          # Here we set CLIENT_URL env var for server and rely on client having built with correct VITE_API_URL earlier if present.
          gcloud run deploy tp5-client-qa \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars VITE_API_URL="$SERVER_URL" \
            --project "$PROJECT"

      - name: Smoke test QA
        run: |
          URL=$(gcloud run services describe tp5-server-qa --region "$REGION" --project "$PROJECT" --format='value(status.url)')
          echo "QA server URL: $URL"
          curl --fail --retry 5 --retry-delay 2 "$URL/health"
      
      - name: Rollback on failure (QA)
        if: failure()
        run: |
          if [ -z "${PREV_IMAGE}" ]; then
            echo "No previous image found, cannot rollback."; exit 1
          fi
          echo "Rolling back to previous image: ${PREV_IMAGE}"
          gcloud run deploy tp5-server-qa --image "${PREV_IMAGE}" --region "${REGION}" --project "${PROJECT}"

  deploy-prod:
    name: Deploy to Production (requires approval)
    needs: deploy-qa
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Record previous server image (PROD)
        id: prev_image_prod
        run: |
          echo "PREV_IMAGE=${{ steps.prev_image_prod_output }}" >> $GITHUB_ENV || true
          echo "PREV_IMAGE=$(gcloud run services describe tp5-server --region ${REGION} --project ${PROJECT} --format='value(spec.template.spec.containers[0].image)')" >> $GITHUB_ENV

      - name: Debug - verify prod secret available
        env:
          GCP_SA_KEY_PROD: ${{ secrets.GCP_SA_KEY_PROD }}
        run: |
          if [ -z "$GCP_SA_KEY_PROD" ]; then
            echo "ERROR: GCP_SA_KEY_PROD is empty or not available in this job"; exit 1
          else
            echo "GCP_SA_KEY_PROD is present"
          fi

      - name: Authenticate to GCP (PROD)
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_PROD }}

      - name: Setup gcloud CLI (PROD)
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          version: 'latest'

      - name: Deploy server PROD (with Cloud SQL)
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-server:${SHA}"
          INSTANCE_CONN_NAME="${{ secrets.INSTANCE_CONN_NAME_PROD }}"
          DB_USER="postgres"
          DB_NAME="${{ secrets.DB_NAME_PROD }}"
          gcloud run deploy tp5-server \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --add-cloudsql-instances "${INSTANCE_CONN_NAME}" \
            --set-env-vars DB_HOST="/cloudsql/${INSTANCE_CONN_NAME}",DB_USER="${DB_USER}",DB_PASS="${{ secrets.DB_PASS_PROD }}",DB_NAME="${DB_NAME}" \
            --project "$PROJECT"

      - name: Canary traffic (PROD) - route 10% to new revision
        run: |
          NEW_REVISION=$(gcloud run services describe tp5-server --region ${REGION} --project ${PROJECT} --format='value(status.latestReadyRevisionName)')
          echo "NEW_REVISION=$NEW_REVISION" >> $GITHUB_ENV
          # keep 90% to previous revision, 10% to new
          gcloud run services update-traffic tp5-server --region ${REGION} --to-revisions ${PREV_REVISION}=90,${NEW_REVISION}=10 --project ${PROJECT}

      - name: Install node deps & Run DB migrations (PROD)
        run: |
          npm ci
          npm run migrate
        env:
          DB_USER: "postgres"
          DB_PASS: ${{ secrets.DB_PASS_PROD }}
          DB_NAME: ${{ secrets.DB_NAME_PROD }}
          DB_HOST: /cloudsql/${{ secrets.INSTANCE_CONN_NAME_PROD }}

      - name: Deploy server PROD
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-server:${SHA}"
          gcloud run deploy tp5-server \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars FORECAST_COUNT=10,CLIENT_URL="https://tp5-client-366o626kia-uc.a.run.app" \
            --project "$PROJECT"

      - name: Deploy client PROD
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-client:${SHA}"
          gcloud run deploy tp5-client \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars VITE_API_URL="https://tp5-server-366o626kia-uc.a.run.app" \
            --project "$PROJECT"

      - name: Smoke test PROD
        run: |
          URL=$(gcloud run services describe tp5-server --region "$REGION" --project "$PROJECT" --format='value(status.url)')
          echo "PROD server URL: $URL"
          curl --fail --retry 5 --retry-delay 2 "$URL/health"

      - name: Promote or Rollback (PROD)
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            # promote new revision to 100% traffic
            gcloud run services update-traffic tp5-server --region ${REGION} --to-revisions ${NEW_REVISION}=100 --project ${PROJECT}
          else
            echo "Smoke tests failed â€” rolling back to previous revision ${PREV_REVISION}"
            gcloud run services update-traffic tp5-server --region ${REGION} --to-revisions ${PREV_REVISION}=100 --project ${PROJECT}
          fi
        if: always()