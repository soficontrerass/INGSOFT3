name: Deploy TP5 to Cloud Run

on:
  push:
    branches: [ main ]
    paths:
      - 'TP5/**'
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      REPO: tp5-repo
      PROJECT: ${{ secrets.GCP_PROJECT_ID }}
      REGION: ${{ secrets.GCP_REGION }}
      SHA: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          version: 'latest'

      - name: Build & push server image
        run: |
          SERVER_IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-server:${SHA}"
          echo "Building and pushing ${SERVER_IMAGE}"
          gcloud builds submit TP5/server --tag "${SERVER_IMAGE}" --project "$PROJECT" --region "$REGION"

      - name: Deploy server to Cloud Run
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-server:${SHA}"
          gcloud run deploy tp5-server \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --set-env-vars FORECAST_COUNT=5 \
            --project "$PROJECT"

      - name: Get server URL
        id: get-server
        run: |
          SERVER_URL=$(gcloud run services describe tp5-server --region "$REGION" --project "$PROJECT" --format='value(status.url)')
          echo "SERVER_URL=$SERVER_URL" >> $GITHUB_OUTPUT

      - name: Build client on runner with server URL
        run: |
          cd TP5/client
          echo "Building client with API=${{ steps.get-server.outputs.SERVER_URL }}"
          # remove windows lock + node_modules so npm will regenerate linux-friendly lock
          rm -rf package-lock.json node_modules
          VITE_API_URL="${{ steps.get-server.outputs.SERVER_URL }}" npm install
          VITE_API_URL="${{ steps.get-server.outputs.SERVER_URL }}" npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Build & push client image (includes dist)
        run: |
          CLIENT_IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-client:${SHA}"
          gcloud builds submit TP5/client --tag "${CLIENT_IMAGE}" --project "$PROJECT" --region "$REGION"

      - name: Deploy client to Cloud Run
        run: |
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT}/${REPO}/tp5-client:${SHA}"
          gcloud run deploy tp5-client \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --project "$PROJECT"

      - name: Smoke test server
        run: |
          URL=$(gcloud run services describe tp5-server --region "$REGION" --project "$PROJECT" --format='value(status.url)')
          echo "Server URL: $URL"
          curl --fail --retry 5 --retry-delay 2 "$URL/health"

      - name: Smoke test client
        run: |
          URL=$(gcloud run services describe tp5-client --region "$REGION" --project "$PROJECT" --format='value(status.url)')
          echo "Client URL: $URL"
          curl --fail --retry 5 --retry-delay 2 "$URL" || true